const API_KEY = process.env.REACT_APP_SCOUTPULSE_API_KEY || '';
const API_BASE_URL = process.env.REACT_APP_API_BASE_URL || 'https://api.scoutpulse.com';

interface AuthResponse {
  token: string;
  user: {
    id: string;
    email: string;
    name: string;
    role: string;
  };
  expiresAt: string;
}

interface LoginCredentials {
  email: string;
  password: string;
}

interface RegisterData {
  email: string;
  password: string;
  name: string;
  organizationName?: string;
}

class AuthService {
  private token: string | null = null;

  constructor() {
    this.token = localStorage.getItem('scoutpulse_token');
  }

  private async makeRequest(endpoint: string, options: RequestInit = {}): Promise<any> {
    const headers = {
      'Content-Type': 'application/json',
      'X-API-Key': API_KEY,
      ...(this.token && { Authorization: `Bearer ${this.token}` }),
      ...options.headers,
    };

    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers,
    });

    if (!response.ok) {
      throw new Error(`Auth request failed: ${response.statusText}`);
    }

    return response.json();
  }

  async login(credentials: LoginCredentials): Promise<AuthResponse> {
    const response = await this.makeRequest('/auth/login', {
      method: 'POST',
      body: JSON.stringify(credentials),
    });

    this.token = response.token;
    localStorage.setItem('scoutpulse_token', response.token);
    
    return response;
  }

  async register(data: RegisterData): Promise<AuthResponse> {
    const response = await this.makeRequest('/auth/register', {
      method: 'POST',
      body: JSON.stringify(data),
    });

    this.token = response.token;
    localStorage.setItem('scoutpulse_token', response.token);
    
    return response;
  }

  async logout(): Promise<void> {
    try {
      await this.makeRequest('/auth/logout', {
        method: 'POST',
      });
    } catch (error) {
      console.error('Logout request failed:', error);
    } finally {
      this.token = null;
      localStorage.removeItem('scoutpulse_token');
    }
  }

  async refreshToken(): Promise<AuthResponse> {
    const response = await this.makeRequest('/auth/refresh', {
      method: 'POST',
    });

    this.token = response.token;
    localStorage.setItem('scoutpulse_token', response.token);
    
    return response;
  }

  async getCurrentUser(): Promise<AuthResponse['user']> {
    const response = await this.makeRequest('/auth/me');
    return response.user;
  }

  isAuthenticated(): boolean {
    return !!this.token;
  }

  getToken(): string | null {
    return this.token;
  }

  async resetPassword(email: string): Promise<void> {
    await this.makeRequest('/auth/reset-password', {
      method: 'POST',
      body: JSON.stringify({ email }),
    });
  }

  async confirmPasswordReset(token: string, newPassword: string): Promise<void> {
    await this.makeRequest('/auth/confirm-reset', {
      method: 'POST',
      body: JSON.stringify({ token, newPassword }),
    });
  }

  async changePassword(currentPassword: string, newPassword: string): Promise<void> {
    await this.makeRequest('/auth/change-password', {
      method: 'POST',
      body: JSON.stringify({ currentPassword, newPassword }),
    });
  }
}

export const authService = new AuthService();
export type { AuthResponse, LoginCredentials, RegisterData };